[tools]
python = "3.12"
uv = "latest"

[env]
# Ensure uv uses the mise-managed Python
UV_PYTHON_PREFERENCE = "managed"

[tasks.modal-secrets]
description = "Create/update Modal secrets from Doppler env vars"
run = """
echo "Creating Modal secrets from Doppler environment..."

# Tigris/S3 credentials (map Doppler names to Modal expected names)
uv run modal secret create tigris-credentials --force \
    TMGG_TIGRIS_BUCKET="$TMGG_S3_BUCKET" \
    TMGG_TIGRIS_ACCESS_KEY="$AWS_ACCESS_KEY_ID" \
    TMGG_TIGRIS_SECRET_KEY="$AWS_SECRET_ACCESS_KEY"

# W&B credentials
uv run modal secret create wandb-credentials --force \
    WANDB_API_KEY="$WANDB_API_KEY"

echo "Modal secrets created successfully"
"""

[tasks.modal-deploy]
description = "Deploy TMGG Modal app to Modal cloud"
depends = ["modal-secrets"]
run = """
# Log outside project to avoid "modified during build" error
LOGDIR="/tmp/tmgg-modal-logs"
LOGFILE="$LOGDIR/modal-deploy-$(date +%Y%m%d-%H%M%S).log"
mkdir -p "$LOGDIR"
echo "Logging to $LOGFILE"
MODAL_LOGLEVEL=DEBUG uv run modal deploy -m tmgg.modal.runner 2>&1 | tee "$LOGFILE"
"""

[tasks.modal-serve]
description = "Run Modal app in development mode (hot-reload)"
run = "uv run modal serve -m tmgg.modal.runner"

# Analysis tasks
[tasks.analyze]
description = "Run full W&B analysis pipeline (download + importance analysis)"
run = "uv run scripts/analyze_experiments.py"

[tasks.analyze-cached]
description = "Run analysis using cached data (skip download)"
run = "uv run scripts/analyze_experiments.py --skip-download"

[tasks.breakdown]
description = "Generate all experiment breakdown reports"
run = "uv run scripts/experiment_breakdown.py --mode full"

[tasks.breakdown-summary]
description = "Generate summary breakdown only"
run = "uv run scripts/experiment_breakdown.py --mode summary"

[tasks.semantic]
description = "Run semantic grouping analysis with significance tests"
run = "uv run scripts/semantic_analysis.py --output eigenstructure_results_full/semantic_analysis_report.md"

[tasks.reports]
description = "Generate all analysis reports (breakdown + semantic)"
depends = ["breakdown", "semantic"]
run = "echo 'All reports generated in eigenstructure_results_full/'"

[tasks.aggregate-mmd]
description = "Aggregate MMD evaluation results from Modal volume into Parquet"
run = "uv run python -m tmgg.modal.cli.aggregate_mmd --output results/mmd_results.parquet --cache-dir results/mmd_cache"

[tasks.aggregate-mmd-dry]
description = "Preview MMD evaluation files without downloading"
run = "uv run python -m tmgg.modal.cli.aggregate_mmd --dry-run"
